{% extends "base.html" %} {% block title %}Menu Management{% endblock %} {%
block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="fw-bold mb-1">Menu Management</h2>
      <p class="text-muted mb-0">Manage your restaurant's menu items</p>
    </div>
    <button
      class="btn btn-primary"
      data-bs-toggle="modal"
      data-bs-target="#addItemModal"
    >
      <i class="bi bi-plus-circle me-2"></i>Add New Item
    </button>
  </div>

  <!-- Filters and Search -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="input-group">
        <span class="input-group-text">
          <i class="bi bi-search"></i>
        </span>
        <input
          type="text"
          class="form-control"
          id="searchItems"
          placeholder="Search menu items..."
        />
      </div>
    </div>
    <div class="col-md-3">
      <select class="form-select" id="categoryFilter">
        <option value="">All Categories</option>
        <option value="food">Food</option>
        <option value="drink">Drinks</option>
      </select>
    </div>
    <div class="col-md-3">
      <select class="form-select" id="sortBy">
        <option value="name">Sort by Name</option>
        <option value="category">Sort by Category</option>
        <option value="price">Sort by Price</option>
        <option value="created_at">Sort by Date Added</option>
      </select>
    </div>
  </div>

  <!-- Menu Items Table -->
  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead class="table-light">
            <tr>
              <th>Name</th>
              <th>Category</th>
              <th>Price</th>
              <th>Status</th>
              <th>Added</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="menuItemsTable">
            <tr>
              <td colspan="6" class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading menu items...</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Add/Edit Item Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Add New Menu Item</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <form id="itemForm">
        <div class="modal-body">
          <input type="hidden" id="itemId" />

          <div class="mb-3">
            <label for="itemName" class="form-label fw-semibold"
              >Item Name</label
            >
            <input type="text" class="form-control" id="itemName" required />
          </div>

          <div class="mb-3">
            <label for="itemCategory" class="form-label fw-semibold"
              >Category</label
            >
            <select class="form-select" id="itemCategory" required>
              <option value="">Select Category</option>
              <option value="food">Food</option>
              <option value="drink">Drink</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="itemPrice" class="form-label fw-semibold"
              >Price ($)</label
            >
            <input
              type="number"
              class="form-control"
              id="itemPrice"
              step="0.01"
              min="0"
              required
            />
          </div>

          <div class="mb-3">
            <label class="form-label fw-semibold">Description (Optional)</label>
            <textarea
              class="form-control"
              id="itemDescription"
              rows="3"
              placeholder="Brief description of the item..."
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-primary" id="saveItemBtn">
            <i class="bi bi-check-circle me-2"></i>Save Item
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Delete</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this menu item?</p>
        <p class="fw-semibold" id="deleteItemName"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
          <i class="bi bi-trash me-2"></i>Delete
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  let menuItems = [];
  let currentEditId = null;

  document.addEventListener("DOMContentLoaded", function () {
    loadMenuItems();
    setupEventListeners();
  });

  async function loadMenuItems() {
    try {
      const response = await fetch("/api/menu-items");
      menuItems = await response.json();
      displayMenuItems(menuItems);
    } catch (error) {
      console.error("Error loading menu items:", error);
      showError("Failed to load menu items");
    }
  }

  function displayMenuItems(items) {
    const tbody = document.getElementById("menuItemsTable");

    if (items.length === 0) {
      tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4">
                        <i class="bi bi-menu-button-wide fs-1 text-muted opacity-50"></i>
                        <p class="mt-2 text-muted">No menu items found</p>
                    </td>
                </tr>
            `;
      return;
    }

    tbody.innerHTML = items
      .map(
        (item) => `
            <tr>
                <td>
                    <div class="fw-semibold">${item.name}</div>
                </td>
                <td>
                    <span class="badge bg-${
                      item.category === "food" ? "primary" : "success"
                    }">
                        ${
                          item.category.charAt(0).toUpperCase() +
                          item.category.slice(1)
                        }
                    </span>
                </td>
                <td class="fw-semibold">$${item.price.toFixed(2)}</td>
                <td>
                    <span class="badge bg-${
                      item.active ? "success" : "secondary"
                    }">
                        ${item.active ? "Active" : "Inactive"}
                    </span>
                </td>
                <td class="text-muted small">
                    ${
                      item.created_at
                        ? new Date(item.created_at).toLocaleDateString()
                        : "N/A"
                    }
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="editItem(${
                          item.id
                        })" title="Edit">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteItem(${
                          item.id
                        }, '${item.name}')" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `
      )
      .join("");
  }

  function setupEventListeners() {
    // Search functionality
    document
      .getElementById("searchItems")
      .addEventListener("input", function () {
        const searchTerm = this.value.toLowerCase();
        const filtered = menuItems.filter((item) =>
          item.name.toLowerCase().includes(searchTerm)
        );
        displayMenuItems(filtered);
      });

    // Category filter
    document
      .getElementById("categoryFilter")
      .addEventListener("change", function () {
        const category = this.value;
        const filtered = category
          ? menuItems.filter((item) => item.category === category)
          : menuItems;
        displayMenuItems(filtered);
      });

    // Sort functionality
    document.getElementById("sortBy").addEventListener("change", function () {
      const sortBy = this.value;
      const sorted = [...menuItems].sort((a, b) => {
        if (sortBy === "price") {
          return a.price - b.price;
        } else if (sortBy === "created_at") {
          return new Date(b.created_at) - new Date(a.created_at);
        } else {
          return a[sortBy].localeCompare(b[sortBy]);
        }
      });
      displayMenuItems(sorted);
    });

    // Form submission
    document
      .getElementById("itemForm")
      .addEventListener("submit", function (e) {
        e.preventDefault();
        saveItem();
      });

    // Modal reset
    document
      .getElementById("addItemModal")
      .addEventListener("hidden.bs.modal", function () {
        resetForm();
      });
  }

  function editItem(id) {
    const item = menuItems.find((i) => i.id === id);
    if (!item) return;

    currentEditId = id;
    document.getElementById("modalTitle").textContent = "Edit Menu Item";
    document.getElementById("itemId").value = id;
    document.getElementById("itemName").value = item.name;
    document.getElementById("itemCategory").value = item.category;
    document.getElementById("itemPrice").value = item.price;

    new bootstrap.Modal(document.getElementById("addItemModal")).show();
  }

  function deleteItem(id, name) {
    currentEditId = id;
    document.getElementById("deleteItemName").textContent = name;

    const modal = new bootstrap.Modal(document.getElementById("deleteModal"));
    modal.show();

    document.getElementById("confirmDeleteBtn").onclick = async function () {
      try {
        const response = await fetch(`/api/menu-items/${id}`, {
          method: "DELETE",
        });

        if (response.ok) {
          modal.hide();
          showSuccess("Menu item deleted successfully");
          loadMenuItems();
        } else {
          showError("Failed to delete menu item");
        }
      } catch (error) {
        console.error("Error deleting item:", error);
        showError("Failed to delete menu item");
      }
    };
  }

  async function saveItem() {
    const formData = {
      name: document.getElementById("itemName").value,
      category: document.getElementById("itemCategory").value,
      price: parseFloat(document.getElementById("itemPrice").value),
    };

    try {
      const isEdit = currentEditId !== null;
      const url = isEdit
        ? `/api/menu-items/${currentEditId}`
        : "/api/menu-items";
      const method = isEdit ? "PUT" : "POST";

      const response = await fetch(url, {
        method: method,
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(formData),
      });

      if (response.ok) {
        bootstrap.Modal.getInstance(
          document.getElementById("addItemModal")
        ).hide();
        showSuccess(`Menu item ${isEdit ? "updated" : "added"} successfully`);
        loadMenuItems();
      } else {
        showError(`Failed to ${isEdit ? "update" : "add"} menu item`);
      }
    } catch (error) {
      console.error("Error saving item:", error);
      showError(`Failed to ${currentEditId ? "update" : "add"} menu item`);
    }
  }

  function resetForm() {
    currentEditId = null;
    document.getElementById("modalTitle").textContent = "Add New Menu Item";
    document.getElementById("itemForm").reset();
    document.getElementById("itemId").value = "";
  }

  function showSuccess(message) {
    showToast(message, "success");
  }

  function showError(message) {
    showToast(message, "danger");
  }

  function showToast(message, type) {
    // Create toast element
    const toastHtml = `
            <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi bi-${
                          type === "success"
                            ? "check-circle"
                            : "exclamation-triangle"
                        } me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;

    // Add to toast container (create if doesn't exist)
    let toastContainer = document.getElementById("toastContainer");
    if (!toastContainer) {
      toastContainer = document.createElement("div");
      toastContainer.id = "toastContainer";
      toastContainer.className =
        "toast-container position-fixed top-0 end-0 p-3";
      toastContainer.style.zIndex = "9999";
      document.body.appendChild(toastContainer);
    }

    toastContainer.insertAdjacentHTML("beforeend", toastHtml);

    // Show toast
    const toastElement = toastContainer.lastElementChild;
    const toast = new bootstrap.Toast(toastElement);
    toast.show();

    // Remove from DOM after hiding
    toastElement.addEventListener("hidden.bs.toast", function () {
      this.remove();
    });
  }
</script>
{% endblock %}
